\documentclass[a4paper]{IEEEtran}
\usepackage[utf8]{inputenc}
\usepackage{color}
\usepackage{graphicx}
\usepackage{mwe}
\usepackage{amsmath}
\usepackage{booktabs}
\usepackage{multicol}

\title{Malware Analysis Report\\\Large{``Sample2.exe''}}
\author{
    \begin{tabular}{lr}
        Contro Filippo &VR437055\\
        Martini Michele &VR437056
    \end{tabular}
}

\begin{document}
	\maketitle
	\section{Executive summary}
	The malware ``Sample2.exe'' shows itself as a calculator app, with the appropriate icon and the expected behavior. Once it is opened by the user there is a simple GUI to perform simple arithmetic operations. Under the hood, however, the malware deactivates the Windows security center, makes many POST request to various internet sites and infects many other files in different locations, from the local folder to the system application's executable.
	
	The whole analysis process has been done on the provided virtual machine, which runs Windows 7 as operating system and contains a bunch of tools to make both static and dynamic analysis. The Reverse engineering instead has been done on local machines.
	
	\section{Static analysis}
	We began the static analysis using \emph{PEStudio}\footnote{https://www.winitor.com/}, a tool which performs malware initial assessment, studying the headers and various information on the executable, which is never executed.
	This first analysis gave us many indicators of probable malicious behavior.
	First of all, we noticed an \emph{entropy} value greater than 7, therefore it's likely that either the file has been packed or some sections has been obfuscated.
	The executable lacks also of a certificate, while the version information disguise it as a ``Windows calculator application file'', with the legal copyright by Microsoft, but there is not a date. The header instead has a compilation time-stamp dating August 2001.
	
	% TODO main PEStudio image

	\noindent The malware's code is made up of four sections:
	\begin{itemize}
		\item \textbf{.text}: the code in clear;
		\item \textbf{.data}: contains global variables;
		\item \textbf{.rsrc}: contains various resources, like images or icons;
		\item \textbf{.vmp0}: main section of the code, obfuscated to make reverse-engineering more difficult.
	\end{itemize}

	% TODO image of the sections

	The last section is the largest with a file-ratio of 81.70\%; it has an entropy greater than 7  and PEStudio marks it as blacklisted. Moreover it is both writable and executable, which is often a malicious evidence, as it indicates self modifying code.
	
	After a little search on the internet we discovered that the name ``vmp'' refers to an obfuscation program called \emph{VMProtect}\footnote{https://vmpsoft.com/}. This program cypher the code exectuting it i a virtual CPU that is different from $x86$. This code obfuscation makes the reverse engineering extremely difficult.
	
	However, the presence of these sections allows us to suppose that the code has not been packed and its high entropy is due to .vmp0 section which is obfuscated. In order to validate this theory, we used \emph{PEID}, a software whose goal is to detect any possible packing. This tool provides three levels of analysis varying in depth. Though every one gave us the same result: ``nothing found'', meaning that PEiD could not detect any packing mechanism.
	
	The executable imports 6 libraries in total, and in particular PEStudio marks as blacklisted 21 functions belonging to \emph{Kernel32.dll} and \emph{user32.dll}. The most interesting are:

	\begin{itemize}
		\item \textbf{getModuleHandleA}: This function let the program call external files, such as \emph{dll} ones;
		\item \textbf{loadLibraryA}: Similar to that one above;
		\item \textbf{getProcAddress}: to get the address of a procedure inside a library;
		\item \textbf{getStartupInfoA}: to get information about startup;
		\item \textbf{getCommandLineW}: to let the program execute code on the command line;
	\end{itemize}
	
	Moreover there are also imports of functions dealing with \emph{Threads}, \emph{Clipboard} and \emph{Windows}.
	This suggest a suspicious behavior, due to the possibility of the program to access to all the libraries of the installed operating system.
	In the dynamic analysis we will see what actions are actually performed.
	The figure below contains all the blacklisted imports detected by PEStudio.
	%TODO image
	
	%TODO Indicators and import analysis
	
	\vspace{1em}
	Regarding strings we notice that those in .text, .data and .rsrc sections are in clear; furthermore many of them are function calls or values used to modify registers.
	Then, there are thousands strings obfuscated and seemingly meaningless which probably belong to .vpm0 section. % thousands -> countless ?	
	
	
	\section{Dynamic analysis}
	Purpouse of dynamic analysis is studying how the malware modify the infected system observing its executions in different situations.
	To accomplish this task we maked use of various tools:
	\begin{itemize}
		\item \textbf{regshot}, which allow us to detect files and registers alterations;
		\item \textbf{procmon}, usefull software for analyze library calls of the virus;
		\item \textbf{fakenet} and \textbf{wireshark}, used to track http requests in isolated environments.
	\end{itemize}
	These programs were executed with administrator permission in order to detect access to restricted locations.
	
	\noindent The analysis proceeded in the following order:
	\begin{enumerate}
		\item launch Fakenet;
		\item launch and setup Procmon;
		\item launch Regshot, setup path and run of its first shot;
		\item start Procmon analysis and launch of the malware;
		\item interaction with calculator;
		\item closing of virus GUI;
		\item stop Procmon tracking and execute Regshot second shot;
		\item registers' shots comparison;
		\item fakenet results analysis.
	\end{enumerate}
	
	
	
	
	\section{Reverse Engineering}
\end{document}