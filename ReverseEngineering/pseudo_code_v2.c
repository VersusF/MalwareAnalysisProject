#include<stdio.h>

int main(){
    int eax, ebx, ecx, edx, edi, esi;
    char al, bl, cl, dl;
    int varC, code_start, var1C, var48, var38, iter, var3C, location8, location10, character_int, var74, var7C, location4C, location50, var18, var54, iter2, var58, var28, var70, var68, var2C, var44, var5C, jter;
    char character;
    
    varC = 9;
    ebx = 0x0A; //Never changes in the first do-while
    var48 = 0x183A;
    code_start = var48 + 0x1FB4 + 0x101BADF - 0x12C2; // 0x101E00B
    var38 = 0x0F4648C58;       // constant
    var1C = 0x13A6 + 0x4F66 + 0x2C6F4;  // constant 0x32A00
    iter = 0;
    var3C = 0x12C2;     // constant

    // STARTS A DO-WHILE
    do {
        // THE BODY
        location10 = 0x101F6CD; //loc_101F6CD, points to a strange address in the code section
        //jter = var1C - 1 + var3C;
        jter = 0x33CC1;
        
        //while (jter > var3C + (0x1E / ebx)) { this is a constant
        while (jter > 0x12C5) {
            printf("address = %i\n", code_start + jter);
            character = *(code_start + jter);    // <- THE STRANGE INSTRUCTION
            character_int = character;   // with sign extend 
            //var74 = iter;  // never used
            //ecx = 6;        // never used

            long long int tmp = iter * 0x0AAAAAAAB; // mul
            eax = tmp & 0xFFFFFFFF; // least 32 bits
            edx = tmp & 0xFFFFFFFF00000000; // upper 32 bits
            edx /= 4;
            //var7C = edx;        // unused
            // at this moment edx is 0 for 0<=iter<=5 and 1 for iter == 6

            edx += var38;   // 0x0F4648C58
            edx = edx & 0xFF;  // cast to char
            // at this point edx is 58 or 59 for if iter is respectively <=5 or ==6
            edx = character_int ^ edx;
            character = edx & 0xFF; // take the real dl
            *(jter + code_start) = character; // DANGEROUS ACCESS TO THE MEMORY
            printf("var1=%i\n", character);
            jter--;
        }

        location8 = 0x109C000; // memory ref to dword_109C000
        iter++;
    } while (iter <= ebx - 4);

    // AT this point the first part of the code has modified many bytes in the beginning
    // of the .vmp0 section, including the header
   
    location4C = 0x10440CD; // A strange constant pointing to vmp0 section
    location50 = 0x11B9000; // Another one pointing to the end of vmp0 section
    
    // This for loop moves a portion of data from location10 to location8
    for (esi = 0; esi < 0x24880; esi++){
        character = *(location10+esi);
        *(location8+esi) = character;
    }

    var18 = 0x104E6CD; // Another stange constant that points to the vmp0 section
    var54 = 0x10000000;
    
    // this other loop moves again pieces of data/code from location4C to location50
    iter2 = 0;
    do{
        cl = *(location4C+iter2); // DANGEROUS ACCESS
        *(iter2+location50) = cl;
        iter2++;
    } while(iter2 < 0x0A1C8);

    // Last part of start
    var58 = 0x105191D;  // Stange constant
    // a function in the data section has a jump to this point
    
    //var28 = 0x153;
    var70 = 0x11E000;
    var68 = *var18;  // DANGEROUS OPERATION
    //var28 += 0x2CB;
    var2C = varC - 9;
    //var28 += 0x0BE2;
    var28 = 0x153 + 0x2CB + 0xBE2; // 0x1000

    // a function in the data section has a jump to this point
    var44 = location8 - var28;
    var5C = var18 + 8 + var2C;
    short var3E = *(var5C);    // 2 bytes    DANGEROUS ACCESS
    edi = (int) var3E; // sign extend
    edi << 4;
    short di = edi & 0xFFFF;  // di is only 2 bytes
    short var32 = di;

    return 0;
}
